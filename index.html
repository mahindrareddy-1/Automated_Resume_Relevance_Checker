{% extends "base.html" %}

{% block title %}Dashboard - Resume Relevance System{% endblock %}

{% block content %}
<!-- Statistics Cards -->
<div class="row mb-5">
    <div class="col-md-3 mb-4">
        <div class="metric-card">
            <i class="fas fa-file-alt fa-3x text-primary mb-3"></i>
            <h3 id="total-resumes" class="fw-bold">0</h3>
            <p class="text-muted mb-0">Total Resumes</p>
        </div>
    </div>
    <div class="col-md-3 mb-4">
        <div class="metric-card">
            <i class="fas fa-chart-line fa-3x text-success mb-3"></i>
            <h3 id="avg-score" class="fw-bold">0.0</h3>
            <p class="text-muted mb-0">Average Score</p>
        </div>
    </div>
    <div class="col-md-3 mb-4">
        <div class="metric-card">
            <i class="fas fa-thumbs-up fa-3x text-success mb-3"></i>
            <h3 id="high-matches" class="fw-bold">0</h3>
            <p class="text-muted mb-0">High Matches</p>
        </div>
    </div>
    <div class="col-md-3 mb-4">
        <div class="metric-card">
            <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
            <h3 id="low-matches" class="fw-bold">0</h3>
            <p class="text-muted mb-0">Low Matches</p>
        </div>
    </div>
</div>

<!-- Charts Section -->
<div class="row mb-5">
    <div class="col-md-6 mb-4">
        <div class="card h-100">
            <div class="card-header bg-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-pie-chart me-2"></i>
                    Verdict Distribution
                </h5>
            </div>
            <div class="card-body">
                <canvas id="verdictChart" width="400" height="400"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-6 mb-4">
        <div class="card h-100">
            <div class="card-header bg-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-bar me-2"></i>
                    Score Distribution
                </h5>
            </div>
            <div class="card-body">
                <canvas id="scoreChart" width="400" height="400"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Recent Results Table -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="fas fa-list me-2"></i>
                    Recent Analysis Results
                </h5>
                <button id="exportBtn" class="btn btn-outline-primary btn-sm" onclick="exportResults()">
                    <i class="fas fa-download me-1"></i>
                    Export CSV
                </button>
            </div>
            <div class="card-body">
                <div id="no-data-message" class="text-center py-5">
                    <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                    <h5>No Analysis Data Available</h5>
                    <p class="text-muted">Start analyzing resumes to see results here.</p>
                    <div class="mt-3">
                        <a href="{{ url_for('analyze_page') }}" class="btn btn-primary me-2">
                            <i class="fas fa-search me-1"></i>
                            Single Analysis
                        </a>
                        <a href="{{ url_for('bulk_page') }}" class="btn btn-outline-primary">
                            <i class="fas fa-upload me-1"></i>
                            Bulk Processing
                        </a>
                    </div>
                </div>
                
                <div id="results-table" class="table-responsive" style="display: none;">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>Resume</th>
                                <th>Score</th>
                                <th>Verdict</th>
                                <th>Hard Match</th>
                                <th>Semantic Match</th>
                                <th>Timestamp</th>
                            </tr>
                        </thead>
                        <tbody id="results-tbody">
                        </tbody>
                    </table>
                </div>
                
                <div id="loading-table" class="text-center py-3" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="text-muted mt-2">Loading dashboard data...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Refresh Button -->
<div class="text-center mt-4">
    <button id="refreshBtn" class="btn btn-outline-primary" onclick="loadDashboard()">
        <i class="fas fa-sync-alt me-1"></i>
        Refresh Data
    </button>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let verdictChart = null;
    let scoreChart = null;

    // Load dashboard data on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadDashboard();
        
        // Auto-refresh every 30 seconds
        setInterval(loadDashboard, 30000);
    });

    function loadDashboard() {
        document.getElementById('loading-table').style.display = 'block';
        document.getElementById('results-table').style.display = 'none';
        document.getElementById('no-data-message').style.display = 'none';
        
        fetch('/api/dashboard')
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showAlert('Error loading dashboard: ' + data.error, 'danger');
                    return;
                }
                
                updateMetrics(data);
                updateCharts(data);
                updateTable(data.recent_results);
                
                document.getElementById('loading-table').style.display = 'none';
                
                if (data.total_resumes === 0) {
                    document.getElementById('no-data-message').style.display = 'block';
                } else {
                    document.getElementById('results-table').style.display = 'block';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('Failed to load dashboard data', 'danger');
                document.getElementById('loading-table').style.display = 'none';
                document.getElementById('no-data-message').style.display = 'block';
            });
    }

    function updateMetrics(data) {
        document.getElementById('total-resumes').textContent = data.total_resumes;
        document.getElementById('avg-score').textContent = data.avg_score.toFixed(1);
        document.getElementById('high-matches').textContent = data.high_count;
        document.getElementById('low-matches').textContent = data.low_count;
    }

    function updateCharts(data) {
        updateVerdictChart(data);
        updateScoreChart(data);
    }

    function updateVerdictChart(data) {
        const ctx = document.getElementById('verdictChart').getContext('2d');
        
        if (verdictChart) {
            verdictChart.destroy();
        }
        
        const verdictData = [data.high_count, data.medium_count, data.low_count];
        const hasData = verdictData.some(val => val > 0);
        
        if (!hasData) {
            ctx.font = '16px Arial';
            ctx.textAlign = 'center';
            ctx.fillStyle = '#6c757d';
            ctx.fillText('No data available', ctx.canvas.width / 2, ctx.canvas.height / 2);
            return;
        }
        
        verdictChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['High', 'Medium', 'Low'],
                datasets: [{
                    data: verdictData,
                    backgroundColor: ['#28a745', '#ffc107', '#dc3545'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            usePointStyle: true,
                            padding: 20
                        }
                    }
                }
            }
        });
    }

    function updateScoreChart(data) {
        const ctx = document.getElementById('scoreChart').getContext('2d');
        
        if (scoreChart) {
            scoreChart.destroy();
        }
        
        if (data.recent_results.length === 0) {
            ctx.font = '16px Arial';
            ctx.textAlign = 'center';
            ctx.fillStyle = '#6c757d';
            ctx.fillText('No data available', ctx.canvas.width / 2, ctx.canvas.height / 2);
            return;
        }
        
        // Create score bins
        const scores = data.recent_results.map(r => r.relevance_score);
        const bins = [0, 20, 40, 60, 80, 100];
        const binLabels = ['0-20', '21-40', '41-60', '61-80', '81-100'];
        const binCounts = new Array(5).fill(0);
        
        scores.forEach(score => {
            const binIndex = Math.min(Math.floor(score / 20), 4);
            binCounts[binIndex]++;
        });
        
        scoreChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: binLabels,
                datasets: [{
                    label: 'Number of Resumes',
                    data: binCounts,
                    backgroundColor: '#667eea',
                    borderRadius: 5
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        }
                    }
                }
            }
        });
    }

    function updateTable(results) {
        const tbody = document.getElementById('results-tbody');
        tbody.innerHTML = '';
        
        results.forEach(result => {
            const row = document.createElement('tr');
            row.className = 'animate-fade-in';
            
            const timestamp = new Date(result.timestamp).toLocaleString();
            
            row.innerHTML = `
                <td>
                    <i class="fas fa-file-alt me-2 text-muted"></i>
                    ${result.filename}
                </td>
                <td>
                    <span class="fw-bold">${result.relevance_score}/100</span>
                </td>
                <td>
                    <span class="${getVerdictClass(result.verdict)}">${result.verdict}</span>
                </td>
                <td>${result.hard_score.toFixed(1)}</td>
                <td>${result.semantic_score.toFixed(1)}</td>
                <td class="text-muted">${timestamp}</td>
            `;
            
            tbody.appendChild(row);
        });
    }

    function exportResults() {
        window.location.href = '/api/export';
    }
</script>
{% endblock %}